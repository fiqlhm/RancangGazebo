<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>woy 24</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Font Modern Geometris -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- DARK CONSTRUCTION THEME --- */
        :root {
            /* Palette: Dark Slate & Blueprint Blue */
            --glass-surface: rgba(15, 23, 42, 0.75); 
            --glass-border: rgba(255, 255, 255, 0.15); 
            --glass-highlight: rgba(255, 255, 255, 0.2); 
            --glass-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); /* Bright Blue Accent */
            --text-primary: #f8fafc; /* Slate 50 */
            --text-secondary: #94a3b8; /* Slate 400 */
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            /* Background Konstruksi Gelap (Night/Concrete) */
            background-image: 
                linear-gradient(to bottom, rgba(15, 23, 42, 0.85), rgba(2, 6, 23, 0.9)), 
                url('https://images.unsplash.com/photo-1504307651254-35680f356dfd?q=80&w=2070&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- GLASSMORPHISM DARK PRO --- */
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px) saturate(120%);
            -webkit-backdrop-filter: blur(20px) saturate(120%);
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-highlight);
            box-shadow: 
                var(--glass-shadow),
                inset 0 0 30px rgba(255,255,255,0.03);
            border-radius: 1.2rem;
            transition: all 0.3s ease;
        }

        .glass-nav {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* --- ANIMATIONS --- */
        @keyframes liquidReveal {
            0% { opacity: 0; transform: translateY(20px) scale(0.98); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .animate-enter {
            animation: liquidReveal 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0; 
        }
        
        /* --- FORM ELEMENTS (Dark Mode) --- */
        .input-liquid {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: #f8fafc;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .input-liquid:focus {
            background: rgba(30, 41, 59, 0.8);
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
            outline: none;
        }
        
        select.input-liquid {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%233b82f6' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
        }
        select.input-liquid option { background-color: #0f172a; color: #f8fafc; }

        /* --- TABLES & CARDS (Dark) --- */
        .card-detail {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* --- BUTTONS --- */
        .btn-ocean {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-ocean:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }
        .btn-ocean:active { transform: scale(0.98); }

        /* --- PRINT --- */
        @media print {
            body { background: white !important; color: black !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .glass-panel, .card-detail { 
                background: white !important; 
                border: 1px solid #ddd !important; 
                box-shadow: none !important; 
                border-radius: 0 !important;
                color: black !important;
            }
            .text-white, .text-gray-200, .text-gray-300, .text-gray-400 { color: black !important; }
            #view-rab, #view-ahsp { display: block !important; }
            #view-ahsp { page-break-before: always; margin-top: 20px; }
            table, th, td { border: 1px solid #000 !important; border-collapse: collapse; }
        }
        .print-only { display: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
    </style>
</head>
<body class="selection:bg-blue-600 selection:text-white">

    <!-- NAVBAR -->
    <nav class="glass-nav fixed w-full top-0 z-50 transition-all duration-300 no-print">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer">
                    <div class="">
                        <i class=""></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white tracking-wide">Bikin<span class="font-light text-blue-400">Gazebo</span></h1>
                    </div>
                </div>
                <button onclick="app.resetData()" class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 text-xs font-bold uppercase transition-all flex items-center gap-2">
                    <i class="fas fa-undo-alt text-blue-400"></i> Reset
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTAINER -->
    <div class="container mx-auto px-4 pt-28 pb-12 flex flex-col lg:flex-row gap-8">
        
        <!-- SIDEBAR (INPUT) -->
        <div class="w-full lg:w-1/3 space-y-6 no-print animate-enter">
            <div class="glass-panel p-4">
                <!-- Tabs -->
                <div class="flex p-1 bg-black/40 rounded-lg mb-6 border border-white/5">
                    <button onclick="ui.switchTab('desain')" id="tab-desain" class="flex-1 py-2.5 rounded-md text-sm font-bold text-white bg-blue-600 shadow-md shadow-blue-900/50">Desain</button>
                    <button onclick="ui.switchTab('harga')" id="tab-harga" class="flex-1 py-2.5 rounded-md text-sm font-bold text-gray-400 hover:text-white hover:bg-white/5 transition-colors">Harga</button>
                    <button onclick="ui.switchTab('settings')" id="tab-settings" class="flex-1 py-2.5 rounded-md text-sm font-bold text-gray-400 hover:text-white hover:bg-white/5 transition-colors">Opsi</button>
                </div>

                <!-- CONTENT: DESAIN -->
                <div id="content-desain" class="space-y-5 px-1">
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10 shadow-sm">
                        <label class="text-xs font-bold text-blue-400 uppercase mb-2 block tracking-wider"><i class="fas fa-drafting-compass mr-1"></i> Bentuk Gazebo</label>
                        <select id="shape" onchange="app.updatePreview()" class="w-full p-3 input-liquid text-sm font-semibold">
                            <option value="persegi">Persegi</option>
                            <option value="persegi_panjang">Persegi Panjang</option>
                            <option value="hexagon">Segi Enam (Hexagon)</option>
                            <option value="octagon">Segi Delapan (Octagon)</option>
                            <option value="lingkaran">Lingkaran</option>
                        </select>
                    </div>

                    <div id="input-dimensi-p" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Panjang (m)</label>
                            <input type="number" id="length" value="3.0" step="0.1" class="w-full p-3 input-liquid font-bold" oninput="app.updatePreview()">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Lebar (m)</label>
                            <input type="number" id="width" value="3.0" step="0.1" class="w-full p-3 input-liquid font-bold" oninput="app.updatePreview()">
                        </div>
                    </div>
                    <div id="input-dimensi-r" class="hidden">
                        <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Jari-jari (m)</label>
                        <input type="number" id="radius" value="2.0" step="0.1" class="w-full p-3 input-liquid font-bold" oninput="app.updatePreview()">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Tinggi Tiang (m)</label>
                            <input type="number" id="height_col" value="2.5" step="0.1" class="w-full p-3 input-liquid font-bold" oninput="app.updatePreview()">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Overstek Atap (m)</label>
                            <input type="number" id="overstek" value="0.6" step="0.1" class="w-full p-3 input-liquid font-bold" oninput="app.updatePreview()">
                        </div>
                    </div>

                    <div class="pt-4 space-y-4 border-t border-white/10">
                        <div>
                            <label class="text-[10px] font-bold text-blue-400 uppercase mb-1 block">Material Struktur Utama</label>
                            <select id="mat_structure" class="w-full p-3 input-liquid text-sm" onchange="app.calculateRAB()">
                                <optgroup label="Kayu (Standar PU)">
                                    <option value="kayu_ulin">Kayu Ulin (Kuat/Tahan Air)</option>
                                    <option value="kayu_bangkirai">Kayu Bangkirai (Klas I)</option>
                                    <option value="kayu_meranti">Kayu Meranti (Ekonomis)</option>
                                </optgroup>
                                <optgroup label="Logam (Modern)">
                                    <option value="besi_hollow">Besi Hollow Galvanis (Analisa kg)</option>
                                    <option value="pipa_galvanis">Pipa Galvanis Medium (Analisa kg)</option>
                                    <option value="baja_wf">Baja WF (Konstruksi Berat)</option>
                                </optgroup>
                                <optgroup label="Lainnya">
                                    <option value="beton_bertulang">Beton Bertulang K-225</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-blue-400 uppercase mb-1 block">Penutup Atap</label>
                            <select id="mat_roof" class="w-full p-3 input-liquid text-sm" onchange="app.calculateRAB()">
                                <option value="sirap">Sirap Kayu Ulin</option>
                                <option value="genteng_keramik">Genteng Keramik Glazur</option>
                                <option value="genteng_metal">Genteng Metal (Sakura/Multi)</option>
                                <option value="seng_gelombang">Seng Gelombang BJLS</option>
                                <option value="atap_onduline">Atap Onduline</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-blue-400 uppercase mb-1 block">Lantai</label>
                            <select id="mat_floor" class="w-full p-3 input-liquid text-sm" onchange="app.calculateRAB()">
                                <optgroup label="Ekonomis (Baru)">
                                    <option value="lantai_papan_meranti">Papan Kayu Meranti (Look Alami)</option>
                                    <option value="lantai_vinyl">Lantai Vinyl Selgrid</option>
                                    <option value="lantai_paving">Paving Block (Outdoor)</option>
                                </optgroup>
                                <optgroup label="Standar">
                                    <option value="keramik_40">Keramik 40x40 (Mulia/Asia)</option>
                                    <option value="keramik_30">Keramik 30x30 (Rustic)</option>
                                    <option value="plester_aci">Rabat Beton + Aci</option>
                                </optgroup>
                                <optgroup label="Premium">
                                    <option value="granit_60">Granit Tile 60x60 (Indogress)</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- CONTENT: HARGA -->
                <div id="content-harga" class="hidden h-[500px] overflow-y-auto pr-2">
                    <div id="price-list-container" class="space-y-3"></div>
                </div>

                <!-- CONTENT: SETTINGS -->
                <div id="content-settings" class="hidden space-y-4 pt-2">
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                        <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Wastage / Sisa Bahan (%)</label>
                        <input type="number" id="param_wastage" value="7" class="w-full p-2 input-liquid text-center font-bold" onchange="app.calculateRAB()">
                    </div>
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                        <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Profit Kontraktor (%)</label>
                        <input type="number" id="param_profit" value="10" class="w-full p-2 input-liquid text-center font-bold" onchange="app.calculateRAB()">
                    </div>
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                        <label class="text-xs font-bold text-gray-400 uppercase mb-2 block">Pajak PPN (%)</label>
                        <input type="number" id="param_tax" value="11" class="w-full p-2 input-liquid text-center font-bold" onchange="app.calculateRAB()">
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN OUTPUT -->
        <div class="w-full lg:w-2/3 space-y-6 animate-enter" style="animation-delay: 0.1s;">
            
            <!-- 2D Preview -->
            <div class="glass-panel p-6 relative no-print">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xl text-white">Visualisasi 2D</h3>
                    <span id="geom-badge" class="px-3 py-1 bg-blue-900/50 text-blue-300 text-[10px] font-bold uppercase rounded-full shadow-sm border border-blue-500/30">HEXAGON</span>
                </div>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 bg-black/40 rounded-xl flex justify-center p-4 border border-white/10 shadow-inner">
                        <canvas id="gazeboCanvas" width="500" height="350" class="w-full h-auto max-w-[500px]"></canvas>
                    </div>
                    <div class="md:w-40 flex flex-col justify-center gap-3" id="geometry-info">
                        <!-- JS Generated -->
                    </div>
                </div>
            </div>

            <!-- Report Panel -->
            <div class="glass-panel p-8 relative" id="print-area">
                
                <!-- Print Header -->
                <div class="print-only border-b-2 border-slate-800 mb-6 pb-4">
                    <h1 class="text-3xl font-bold text-slate-800">Rencana Anggaran Biaya</h1>
                    <p class="text-slate-600">Gazebo Project Estimation (Standar PU & SNI)</p>
                    <p class="text-xs mt-2 text-slate-400" id="print-date"></p>
                </div>

                <!-- Screen Header -->
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 no-print gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-white drop-shadow-sm">Estimasi Biaya</h2>
                        <p class="text-gray-400 text-sm">Kalkulasi Otomatis (Metode SNI - Std. PU)</p>
                    </div>
                    <button onclick="window.print()" class="btn-ocean px-6 py-3 rounded-xl font-bold text-sm tracking-wide flex items-center gap-2">
                        <i class="fas fa-print"></i> CETAK PDF
                    </button>
                </div>

                <!-- Summary Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white/5 p-5 rounded-2xl border border-white/10 shadow-sm hover:-translate-y-1 transition-transform duration-300">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Konstruksi</p>
                        <p class="text-2xl font-bold text-blue-400" id="val-physical">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-5 rounded-2xl shadow-lg text-white border border-blue-500/50">
                        <p class="text-[10px] font-bold text-blue-200 uppercase tracking-widest mb-1">Total Biaya</p>
                        <p class="text-2xl font-bold" id="val-total">Rp 0</p>
                    </div>
                    <div class="bg-white/5 p-5 rounded-2xl border border-white/10 shadow-sm hover:-translate-y-1 transition-transform duration-300">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Per Meter</p>
                        <p class="text-xl font-bold text-white" id="val-perm2">Rp 0</p>
                    </div>
                </div>

                <!-- Toggle -->
                <div class="flex gap-2 mb-6 no-print">
                    <button onclick="ui.switchReport('rab')" id="btn-view-rab" class="px-5 py-2.5 rounded-lg text-sm font-bold bg-white text-blue-900 shadow-sm border border-slate-100">RAB Detail</button>
                    <button onclick="ui.switchReport('ahsp')" id="btn-view-ahsp" class="px-5 py-2.5 rounded-lg text-sm font-bold bg-transparent border border-white/20 text-gray-400 hover:bg-white/5 transition-colors">Analisis (AHSP)</button>
                </div>

                <!-- REPORT TABLES CONTAINER -->
                <div class="card-detail min-h-[300px]">
                    
                    <!-- View RAB -->
                    <div id="view-rab" class="animate-enter">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-gray-300">
                                <thead class="bg-black/20 text-gray-400 border-b border-white/10">
                                    <tr>
                                        <th class="px-4 py-3 text-center w-10">No</th>
                                        <th class="px-4 py-3 text-left">Pekerjaan & Rincian Perhitungan</th>
                                        <th class="px-4 py-3 text-center w-16">Vol</th>
                                        <th class="px-4 py-3 text-center w-12">Sat</th>
                                        <th class="px-4 py-3 text-right">Harga Sat</th>
                                        <th class="px-4 py-3 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="rab-table-body" class="divide-y divide-white/5"></tbody>
                                <tfoot class="bg-black/30 font-bold text-gray-200 border-t border-white/10">
                                    <tr><td colspan="5" class="px-4 py-2 text-right text-xs uppercase text-gray-500">Subtotal Fisik</td><td class="px-4 py-2 text-right text-white" id="footer-fisik">0</td></tr>
                                    <tr><td colspan="5" class="px-4 py-2 text-right text-xs uppercase text-gray-500">Jasa Kontraktor (<span id="disp-profit">10</span>%)</td><td class="px-4 py-2 text-right text-green-400" id="footer-profit">0</td></tr>
                                    <tr><td colspan="5" class="px-4 py-2 text-right text-xs uppercase text-gray-500">PPN (<span id="disp-tax">11</span>%)</td><td class="px-4 py-2 text-right text-red-400" id="footer-tax">0</td></tr>
                                    <tr class="bg-blue-900/40 text-white text-base"><td colspan="5" class="px-4 py-4 text-right">TOTAL ESTIMASI</td><td class="px-4 py-4 text-right text-blue-300 text-lg" id="footer-total">0</td></tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- View AHSP -->
                    <div id="view-ahsp" class="hidden p-6 animate-enter">
                        <div id="ahsp-container" class="space-y-6"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
// --- CORE LOGIC ---
const defaultPrices = {
    // Material Struktur (Sesuai Dokumen PU Balikpapan)
    'kayu_ulin': { name: 'Kayu Ulin (Balok)', unit: 'm3', price: 6760000, source: 'Std PU' },
    'kayu_bangkirai': { name: 'Kayu Bangkirai (Balok)', unit: 'm3', price: 6240000, source: 'Std PU' },
    'kayu_meranti': { name: 'Kayu Meranti (Balok)', unit: 'm3', price: 2756000, source: 'Std PU' },
    'papan_ulin': { name: 'Papan Ulin', unit: 'm3', price: 6240000, source: 'Std PU' },
    
    // Besi & Logam (Harga Konversi ke KG untuk SNI)
    // Harga batang: Besi Hollow 40x60 = 147.200 (Std PU). Berat per btg 6m approx 9kg -> 16.355/kg
    'besi_hollow': { name: 'Besi Hollow/Profil', unit: 'kg', price: 16355, source: 'Std PU (Konversi)' }, 
    // Pipa Galvanis 3" = 1.171.500 (Std PU). Berat approx 30kg/btg -> 39.050/kg
    'pipa_galvanis': { name: 'Pipa Galvanis', unit: 'kg', price: 39050, source: 'Std PU (Konversi)' },
    'baja_wf': { name: 'Baja WF Profil', unit: 'kg', price: 16026, source: 'Std PU' },
    
    // Atap
    'sirap': { name: 'Atap Sirap Ulin', unit: 'm2', price: 64400, source: 'Est (80bh/m2 x 805)' }, 
    'genteng_keramik': { name: 'Genteng Keramik Glazur', unit: 'bh', price: 16480, source: 'Std PU (Kanmuri)' },
    'genteng_metal': { name: 'Genteng Metal (Sakura Roof)', unit: 'lbr', price: 116523, source: 'Std PU' },
    'seng_gelombang': { name: 'Seng Gelombang BJLS 30', unit: 'lbr', price: 77682, source: 'Std PU' },
    'atap_onduline': { name: 'Atap Onduline', unit: 'lbr', price: 197248, source: 'Std PU' },
    
    // Lantai
    'granit_60': { name: 'Granit Tile 60x60', unit: 'm2', price: 345565, source: 'Std PU (Indogress)' },
    'keramik_40': { name: 'Keramik 40x40', unit: 'm2', price: 60500, source: 'Std PU (Mulia)' },
    'keramik_30': { name: 'Keramik 30x30 Rustic', unit: 'm2', price: 63250, source: 'Std PU (Asia)' },
    
    // -- LANTAI MURAH --
    'papan_meranti': { name: 'Papan Meranti', unit: 'm3', price: 2912000, source: 'Std PU (X.3.5.15)' },
    'lantai_vinyl': { name: 'Lantai Kayu Vinyl Selgrid', unit: 'm2', price: 231000, source: 'Std PU (X.3.10.4.1.54)' },
    'paving_block': { name: 'Paving Block Abu (6cm)', unit: 'bh', price: 2537, source: 'Std PU (X.3.10.5.13)' },

    // Pendukung & Auxiliary SNI
    'paku': { name: 'Paku Biasa', unit: 'kg', price: 27122, source: 'Std PU' },
    'baut': { name: 'Baut/Mur', unit: 'psg', price: 3300, source: 'Std PU' },
    'semen': { name: 'Semen PC (50kg)', unit: 'zak', price: 68480, source: 'Std PU (Gresik)' },
    'semen_kg': { name: 'Semen PC', unit: 'kg', price: 1370, source: 'Std PU (Konversi 50kg)' },
    'pasir': { name: 'Pasir Beton', unit: 'm3', price: 428800, source: 'Std PU' },
    'pasir_urug': { name: 'Pasir Urug', unit: 'm3', price: 160800, source: 'Std PU' },
    'kerikil': { name: 'Kerikil/Split', unit: 'm3', price: 484000, source: 'Std PU (Sungai Lokal)' },
    'cat_kayu': { name: 'Cat Kayu Synthetic', unit: 'kg', price: 89200, source: 'Std PU' },
    'cat_besi': { name: 'Cat Besi/Anti Karat', unit: 'kg', price: 66936, source: 'Std PU' },
    'las': { name: 'Kawat Las', unit: 'dos', price: 194040, source: 'Std PU' },
    'bekisting': { name: 'Papan Bekisting (Meranti)', unit: 'm3', price: 2251200, source: 'Std PU' }, 
    'lem_kuning': { name: 'Lem Vinyl/Kuning', unit: 'kg', price: 65000, source: 'Est' },

    // Upah (Std PU)
    'tukang': { name: 'Tukang', unit: 'OH', price: 129800, source: 'Std PU' },
    'pekerja': { name: 'Pekerja Terampil', unit: 'OH', price: 121600, source: 'Std PU' },
    'mandor': { name: 'Mandor', unit: 'OH', price: 137800, source: 'Std PU' },
    'kepala_tukang': { name: 'Kepala Tukang', unit: 'OH', price: 145900, source: 'Std PU' }
};

// SNI Analysis Templates (Koefisien)
const SNI_ANALYSIS = {
    'beton_bertulang': {
        unit: 'm3',
        labor: { pekerja: 2.0, tukang: 0.35, kepala: 0.035, mandor: 0.1 },
        materials: [ 
            { id: 'semen_kg', coef: 336 }, 
            { id: 'pasir', coef: 0.54 }, 
            { id: 'kerikil', coef: 0.81 }, 
            { id: 'bekisting', coef: 10 }, // 10 m2 bekisting/m3 beton (est) - pake harga m3 papan = 10*0.02 = 0.2
            { id: 'paku', coef: 4.0 },
            { id: 'baja_wf', coef: 110 } // Besi beton (kg)
        ]
    },
    'pondasi_umpak': {
        unit: 'm3',
        labor: { pekerja: 1.65, tukang: 0.275, kepala: 0.028, mandor: 0.083 },
        materials: [
            { id: 'semen_kg', coef: 326 },
            { id: 'pasir', coef: 0.52 },
            { id: 'kerikil', coef: 0.78 },
            { id: 'bekisting', coef: 5 }, // 5m2 bekisting/m3 -> 0.1 m3 papan
            { id: 'paku', coef: 1.5 }
        ]
    },
    'rangka_besi': {
        unit: 'kg',
        labor: { pekerja: 0.06, tukang: 0.06, kepala: 0.006, mandor: 0.003 },
        materials: [
            { id: 'las', coef: 0.04 }, // Elektroda
            { id: 'cat_besi', coef: 0.035 }
        ]
    },
    'rangka_kayu': {
        unit: 'm3',
        labor: { pekerja: 4.0, tukang: 12.0, kepala: 1.2, mandor: 0.2 },
        materials: [
            { id: 'baut', coef: 15 },
            { id: 'paku', coef: 5.6 },
            { id: 'cat_kayu', coef: 3.5 } // Finishing
        ]
    },
    'atap_genteng_keramik': {
        unit: 'm2',
        labor: { pekerja: 0.15, tukang: 0.075, kepala: 0.008, mandor: 0.008 },
        materials: [ { id: 'genteng_keramik', coef: 14 } ] // 14 bh/m2
    },
    'atap_seng': {
        unit: 'm2',
        labor: { pekerja: 0.12, tukang: 0.06, kepala: 0.006, mandor: 0.006 },
        materials: [ 
            { id: 'seng_gelombang', coef: 1.2 }, // Overlap 20%
            { id: 'paku', coef: 0.04 }
        ]
    },
    'lantai_keramik': {
        unit: 'm2',
        labor: { pekerja: 0.7, tukang: 0.35, kepala: 0.035, mandor: 0.035 },
        materials: [
            { id: 'semen_kg', coef: 10 },
            { id: 'pasir', coef: 0.045 }
        ]
    },
    'lantai_paving': {
        unit: 'm2',
        labor: { pekerja: 0.5, tukang: 0.25, kepala: 0.025, mandor: 0.025 },
        materials: [
            { id: 'paving_block', coef: 48 }, // 48 bh/m2
            { id: 'pasir_urug', coef: 0.1 } // 10cm sand bedding
        ]
    },
    'lantai_kayu': {
        unit: 'm2',
        labor: { pekerja: 0.6, tukang: 1.5, kepala: 0.15, mandor: 0.03 },
        materials: [
            { id: 'papan_meranti', coef: 0.03 }, // Tebal 2.5cm + waste
            { id: 'paku', coef: 0.3 },
            { id: 'cat_kayu', coef: 0.4 }
        ]
    },
    'lantai_vinyl': {
        unit: 'm2',
        labor: { pekerja: 0.3, tukang: 0.45, kepala: 0.045, mandor: 0.015 },
        materials: [
            { id: 'lantai_vinyl', coef: 1.05 }, // 5% waste
            { id: 'lem_kuning', coef: 0.35 }
        ]
    }
};

const savedPrices = JSON.parse(localStorage.getItem('gazebo_prices')) || {};
let prices = { ...defaultPrices, ...savedPrices };

const ui = {
    fmt: (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n),
    switchTab: (t) => {
        ['desain', 'harga', 'settings'].forEach(x => {
            document.getElementById(`content-${x}`).classList.add('hidden');
            const btn = document.getElementById(`tab-${x}`);
            btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'shadow-blue-900/50');
            btn.classList.add('text-gray-400', 'hover:text-white', 'hover:bg-white/5');
        });
        document.getElementById(`content-${t}`).classList.remove('hidden');
        const active = document.getElementById(`tab-${t}`);
        active.classList.remove('text-gray-400', 'hover:text-white', 'hover:bg-white/5');
        active.classList.add('bg-blue-600', 'text-white', 'shadow-md', 'shadow-blue-900/50');
    },
    switchReport: (view) => {
        const rabBtn = document.getElementById('btn-view-rab');
        const ahspBtn = document.getElementById('btn-view-ahsp');
        
        if(view === 'rab') {
            document.getElementById('view-rab').classList.remove('hidden');
            document.getElementById('view-ahsp').classList.add('hidden');
            
            rabBtn.classList.remove('bg-transparent', 'border-white/20', 'text-gray-400', 'hover:bg-white/5');
            rabBtn.classList.add('bg-white', 'text-blue-900', 'shadow-sm');
            
            ahspBtn.classList.remove('bg-white', 'text-blue-900', 'shadow-sm');
            ahspBtn.classList.add('bg-transparent', 'border-white/20', 'text-gray-400', 'hover:bg-white/5');
        } else {
            document.getElementById('view-rab').classList.add('hidden');
            document.getElementById('view-ahsp').classList.remove('hidden');
            
            ahspBtn.classList.remove('bg-transparent', 'border-white/20', 'text-gray-400', 'hover:bg-white/5');
            ahspBtn.classList.add('bg-white', 'text-blue-900', 'shadow-sm');
            
            rabBtn.classList.remove('bg-white', 'text-blue-900', 'shadow-sm');
            rabBtn.classList.add('bg-transparent', 'border-white/20', 'text-gray-400', 'hover:bg-white/5');
        }
    },
    renderPriceTable: () => {
        const c = document.getElementById('price-list-container');
        let h = '';
        for(let k in prices) {
            h += `<div class="flex items-center justify-between p-3 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all group shadow-sm">
                <div class="w-1/2">
                    <div class="font-bold text-gray-200 text-sm group-hover:text-blue-400 transition-colors">${prices[k].name}</div>
                    <div class="text-[10px] text-gray-500 flex items-center mt-1">
                        <span class="mr-1">Src:</span>
                        <input type="text" value="${prices[k].source}" class="bg-transparent border-b border-gray-600 w-24 text-gray-400 focus:outline-none focus:border-blue-400 text-[10px]" onchange="app.updateSource('${k}',this.value)">
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold bg-black/20 px-2 py-1 rounded border border-white/5 text-gray-400">${prices[k].unit}</span>
                    <input type="number" value="${prices[k].price}" class="w-28 px-2 py-1 rounded-lg text-right font-mono font-bold text-white bg-white/5 border border-white/10 focus:bg-black/40 focus:border-blue-400 focus:outline-none transition-all text-sm" onchange="app.updatePrice('${k}',this.value)">
                </div>
            </div>`;
        }
        c.innerHTML = h;
    }
};

const app = {
    currentGeom: {},

    init: () => {
        ui.renderPriceTable();
        app.updatePreview();
        const d = new Date();
        document.getElementById('print-date').innerText = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        
        window.addEventListener('scroll', () => {
            const nav = document.querySelector('nav');
            if(window.scrollY > 20) {
                nav.classList.add('bg-black/40', 'backdrop-blur-xl', 'shadow-sm');
            } else {
                nav.classList.remove('bg-black/40', 'backdrop-blur-xl', 'shadow-sm');
            }
        });
    },

    resetData: () => {
        if(confirm("Reset harga ke standar Dinas PU?")) {
            localStorage.removeItem('gazebo_prices');
            prices = JSON.parse(JSON.stringify(defaultPrices));
            ui.renderPriceTable();
            app.calculateRAB();
        }
    },

    updatePrice: (key, val) => {
        if(prices[key]) {
            prices[key].price = parseFloat(val);
            localStorage.setItem('gazebo_prices', JSON.stringify(prices));
            app.calculateRAB();
        }
    },
    
    updateSource: (key, val) => {
        if(prices[key]) {
            prices[key].source = val;
            localStorage.setItem('gazebo_prices', JSON.stringify(prices));
        }
    },

    calculateGeometry: () => {
        const shape = document.getElementById('shape').value;
        let area = 0, perimeter = 0, roofArea = 0;
        
        const inputsP = document.getElementById('input-dimensi-p');
        const inputsR = document.getElementById('input-dimensi-r');
        const heightCol = parseFloat(document.getElementById('height_col').value);
        const overstek = parseFloat(document.getElementById('overstek').value);

        if (['persegi', 'persegi_panjang'].includes(shape)) {
            inputsP.classList.remove('hidden'); inputsR.classList.add('hidden');
            const l = parseFloat(document.getElementById('length').value);
            const w = shape === 'persegi' ? l : parseFloat(document.getElementById('width').value);
            if(shape === 'persegi') document.getElementById('width').value = l;
            area = l * w;
            perimeter = 2 * (l + w);
            roofArea = (l + 2*overstek) * (w + 2*overstek) / 0.819; 
        } else {
            inputsP.classList.add('hidden'); inputsR.classList.remove('hidden');
            const r = parseFloat(document.getElementById('radius').value);
            
            if (shape === 'hexagon') { area = 2.598 * r * r; perimeter = 6 * r; }
            else if (shape === 'octagon') { area = 2.828 * r * r; perimeter = 6.12 * r; } 
            else { area = Math.PI * r * r; perimeter = 2 * Math.PI * r; }
            
            const r_roof = r + overstek;
            roofArea = Math.PI * r_roof * (r_roof / 0.819);
        }

        app.currentGeom = { shape, area, perimeter, roofArea, heightCol };
        document.getElementById('geom-badge').innerText = shape.toUpperCase().replace('_', ' ');
        document.getElementById('geometry-info').innerHTML = `
            <div class="bg-white/10 p-2 rounded-xl text-center border border-white/10 backdrop-blur-sm shadow-sm">
                <p class="text-[9px] text-gray-400 uppercase font-bold tracking-widest">Luas Lantai</p>
                <p class="font-bold text-white">${area.toFixed(2)} m²</p>
            </div>
            <div class="bg-white/10 p-2 rounded-xl text-center border border-white/10 backdrop-blur-sm shadow-sm">
                <p class="text-[9px] text-gray-400 uppercase font-bold tracking-widest">Luas Atap</p>
                <p class="font-bold text-white">${roofArea.toFixed(2)} m²</p>
            </div>
            <div class="bg-white/10 p-2 rounded-xl text-center border border-white/10 backdrop-blur-sm shadow-sm">
                <p class="text-[9px] text-gray-400 uppercase font-bold tracking-widest">Keliling</p>
                <p class="font-bold text-white">${perimeter.toFixed(2)} m'</p>
            </div>
        `;
        return app.currentGeom;
    },

    drawCanvas: (geom) => {
        const canvas = document.getElementById('gazeboCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width, h = canvas.height;
        const cx = w/2, cy = h/2, scale = 40; 
        ctx.clearRect(0,0,w,h);

        const poly = (n, r, fill, stroke) => {
            ctx.beginPath();
            for(let i=0; i<=n; i++) {
                const a = (i*2*Math.PI/n) - (Math.PI/2);
                ctx.lineTo(cx + r*scale*Math.cos(a), cy + r*scale*Math.sin(a));
            }
            ctx.fillStyle = fill; ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = stroke; ctx.stroke();
        };

        if(geom.shape.includes('persegi')) {
            const l = parseFloat(document.getElementById('length').value);
            const wd = parseFloat(document.getElementById('width').value);
            const os = parseFloat(document.getElementById('overstek').value);
            
            ctx.fillStyle='rgba(59, 130, 246, 0.2)'; 
            ctx.fillRect(cx-((wd/2+os)*scale), cy-((l/2+os)*scale), (wd+2*os)*scale, (l+2*os)*scale);
            ctx.strokeStyle='rgba(96, 165, 250, 0.8)';
            ctx.strokeRect(cx-((wd/2+os)*scale), cy-((l/2+os)*scale), (wd+2*os)*scale, (l+2*os)*scale);
            
            ctx.fillStyle='rgba(255, 255, 255, 0.1)'; 
            ctx.fillRect(cx-(wd/2*scale), cy-(l/2*scale), wd*scale, l*scale);
            ctx.strokeStyle='rgba(255, 255, 255, 0.3)'; 
            ctx.strokeRect(cx-(wd/2*scale), cy-(l/2*scale), wd*scale, l*scale);
        } else {
            const r = parseFloat(document.getElementById('radius').value);
            const os = parseFloat(document.getElementById('overstek').value);
            const n = geom.shape==='hexagon'?6:(geom.shape==='octagon'?8:50);
            
            poly(n, r+os, 'rgba(59, 130, 246, 0.2)', 'rgba(96, 165, 250, 0.8)');
            poly(n, r, 'rgba(255, 255, 255, 0.1)', 'rgba(255, 255, 255, 0.3)');
        }
    },
    
    updatePreview: () => {
        const geom = app.calculateGeometry();
        app.drawCanvas(geom);
        app.calculateRAB();
    },

    calculateRAB: () => {
        const g = app.currentGeom;
        const wastage = parseFloat(document.getElementById('param_wastage').value) / 100;
        const profit = parseFloat(document.getElementById('param_profit').value) / 100;
        const tax = parseFloat(document.getElementById('param_tax').value) / 100;
        
        const matStruct = document.getElementById('mat_structure').value;
        const matRoof = document.getElementById('mat_roof').value;
        const matFloor = document.getElementById('mat_floor').value;
        
        const items = [];

        // Helper to get AHSP
        const getAnalysis = (key, volume, mainMatKey) => {
            const template = SNI_ANALYSIS[key];
            if (!template) return null;
            
            const matPrice = prices[mainMatKey] || { price: 0, name: mainMatKey, unit: '-' };
            const tukang = prices['tukang'];
            const pekerja = prices['pekerja'];
            const mandor = prices['mandor'];
            const kepala = prices['kepala_tukang'];

            // Main Material Cost
            // If mainMatKey exists in materials array of template, use coef from template.
            // Otherwise assume coef = 1.0 (or adjust based on volume logic)
            let mainMatCoef = 1.0;
            // Check if mainMat is already in aux list of template, if so use that coef
            // For simplicity, we treat the 'mainMatKey' passed as the primary material. 
            // BUT for 'beton_bertulang', the main material is actually a mix.
            
            let baseCost = 0;
            let wasteCost = 0;
            
            // Calculate Auxiliary Materials from Template
            const auxDetails = template.materials.map(mat => {
                // If the material in template is same as mainMatKey, we consider it the main one
                let priceObj = prices[mat.id];
                // Fallback for dynamic main material (e.g. kayu type)
                if (mat.id === 'main_material') priceObj = prices[mainMatKey];
                
                if (!priceObj) return { name: mat.id, unit: '?', price: 0, coef: 0, total: 0 };
                
                const cost = priceObj.price * mat.coef;
                return { name: priceObj.name, unit: priceObj.unit, price: priceObj.price, coef: mat.coef, total: cost };
            });

            // Special handling: if mainMatKey is NOT in the template materials, add it as main
            // For Wood: 'rangka_kayu' template doesn't have the wood itself because it varies (Ulin/Meranti)
            if (!template.materials.find(m => m.id === mainMatKey) && !template.materials.find(m => m.id === 'main_material')) {
                 // Add the wood/steel itself
                 // Usually for wood analysis 1m3, need 1.1 m3 material
                 const mainCoef = 1.1; 
                 const p = prices[mainMatKey];
                 auxDetails.unshift({ name: p.name, unit: p.unit, price: p.price, coef: mainCoef, total: p.price * mainCoef });
            }

            const matTotal = auxDetails.reduce((s, x) => s + x.total, 0);
            
            // Calculate Labor
            const laborDetails = [];
            const l = template.labor;
            if(l.pekerja) laborDetails.push({ role: 'Pekerja', coef: l.pekerja, price: pekerja.price, total: l.pekerja * pekerja.price });
            if(l.tukang) laborDetails.push({ role: 'Tukang', coef: l.tukang, price: tukang.price, total: l.tukang * tukang.price });
            if(l.kepala) laborDetails.push({ role: 'Kepala Tukang', coef: l.kepala, price: kepala.price, total: l.kepala * kepala.price });
            if(l.mandor) laborDetails.push({ role: 'Mandor', coef: l.mandor, price: mandor.price, total: l.mandor * mandor.price });
            
            const laborTotal = laborDetails.reduce((s, x) => s + x.total, 0);
            const toolCost = laborTotal * 0.05; // 5% Alat
            
            const unitPrice = matTotal + laborTotal + toolCost;
            
            return {
                unitPrice,
                totalPrice: unitPrice * volume,
                breakdown: {
                    // Fake mainMat obj for display consistency with previous logic
                    mainMat: { name: "Analisa Harga Satuan", coef: 1, price: unitPrice, base: unitPrice, waste: 0, subtotal: unitPrice },
                    auxMat: auxDetails,
                    labor: laborDetails,
                    tool: toolCost
                }
            };
        };

        const addItem = (title, vol, unit, analysisKey, mainMatKey) => {
            const data = getAnalysis(analysisKey, vol, mainMatKey);
            if(data) {
                items.push({ title, vol, unit, ...data });
            }
        };

        const numCols = g.shape === 'hexagon' ? 6 : (g.shape === 'octagon' ? 8 : 4);
        
        // 1. PONDASI
        const volPondasi = numCols * 0.15; // m3
        if(matStruct === 'beton_bertulang') {
            addItem("Pondasi Beton Bertulang (SNI 7394)", volPondasi, "m3", "beton_bertulang", "semen_kg");
        } else {
            addItem("Pondasi Umpak (SNI 7394)", volPondasi, "m3", "pondasi_umpak", "semen_kg");
        }
        
        // 2. STRUKTUR UTAMA
        if (matStruct === 'beton_bertulang') {
             const volBeton = g.area * 0.15; // m3 estimation
             addItem("Struktur Beton Bertulang K-225", volBeton, "m3", "beton_bertulang", "semen_kg");
        } else if (matStruct.includes('kayu') || matStruct.includes('papan')) {
             const volKayu = g.area * 0.08; // m3
             addItem(`Rangka Kayu (${prices[matStruct].name})`, volKayu, "m3", "rangka_kayu", matStruct);
        } else {
             // BESI / BAJA (Analisa KG)
             // Convert volume to weight approx
             let weight = 0;
             if(matStruct === 'baja_wf') weight = g.area * 35; // 35kg/m2
             else weight = g.area * 15; // Hollow/Pipa lighter 15kg/m2
             
             addItem(`Rangka Besi/Baja (${prices[matStruct].name})`, weight, "kg", "rangka_besi", matStruct);
        }
        
        // 3. ATAP
        if(matRoof === 'genteng_keramik') addItem("Penutup Atap Genteng Keramik", g.roofArea, "m2", "atap_genteng_keramik", matRoof);
        else if(matRoof === 'seng_gelombang') addItem("Penutup Atap Seng BJLS", g.roofArea, "m2", "atap_seng", matRoof);
        else addItem("Penutup Atap (Metal/Onduline)", g.roofArea, "m2", "atap_seng", matRoof); // Use Seng analysis as generic sheet metal
        
        // 4. LANTAI
        if(matFloor === 'lantai_papan_meranti') addItem("Lantai Papan Kayu", g.area, "m2", "lantai_kayu", "papan_meranti");
        else if(matFloor === 'lantai_paving') addItem("Lantai Paving Block", g.area, "m2", "lantai_paving", "paving_block");
        else if(matFloor === 'lantai_vinyl') addItem("Lantai Vinyl", g.area, "m2", "lantai_vinyl", "lantai_vinyl");
        else addItem("Lantai Keramik/Granit", g.area, "m2", "lantai_keramik", matFloor);

        app.renderOutputs(items, profit, tax);
    },

    renderOutputs: (items, profitPct, taxPct) => {
        const rabBody = document.getElementById('rab-table-body');
        const ahspContainer = document.getElementById('ahsp-container');
        rabBody.innerHTML = ''; ahspContainer.innerHTML = '';
        
        let subtotal = 0;

        items.forEach((item, idx) => {
            subtotal += item.totalPrice;
            const bd = item.breakdown;
            
            // RAB ROW
            // Summarize cost per item type
            const matCost = bd.auxMat.reduce((s,x)=>s+x.total,0) * item.vol;
            const laborCost = bd.labor.reduce((s,x)=>s+x.total,0) * item.vol;
            
            rabBody.innerHTML += `
            <tr class="align-top hover:bg-white/5 group transition-colors border-b border-white/5 last:border-0">
                <td class="text-center py-4 text-gray-500 font-bold group-hover:text-blue-400">${idx+1}</td>
                <td class="py-4 px-4">
                    <span class="font-bold text-gray-200 text-sm block mb-1">${item.title}</span>
                    <div class="text-[10px] text-gray-400 pl-2 border-l border-blue-500/30">
                       <div>Material: ${ui.fmt(matCost)}</div>
                       <div>Upah: ${ui.fmt(laborCost)}</div>
                    </div>
                </td>
                <td class="text-center py-4 font-medium text-gray-400">${item.vol.toFixed(2)}</td>
                <td class="text-center py-4 text-gray-500 text-xs uppercase">${item.unit}</td>
                <td class="text-right py-4 px-4 text-gray-400 font-mono text-xs">${ui.fmt(item.unitPrice)}</td>
                <td class="text-right py-4 px-4 font-bold text-blue-400 font-mono text-sm">${ui.fmt(item.totalPrice)}</td>
            </tr>`;

            // AHSP ROW
            const auxRows = bd.auxMat.map(a => `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="pl-4 py-2 text-gray-300 border-r border-white/5">${a.name}</td>
                    <td class="text-center py-2 border-r border-white/5 text-gray-400 text-xs">${a.unit}</td>
                    <td class="text-center py-2 border-r border-white/5 text-gray-400 font-mono text-xs">${a.coef.toFixed(4)}</td>
                    <td class="text-right py-2 border-r border-white/5 px-3 text-gray-400 font-mono text-xs">${ui.fmt(a.price)}</td>
                    <td class="text-right py-2 px-3 font-medium text-gray-300 font-mono text-xs">${ui.fmt(a.total)}</td>
                </tr>`).join('');

            const laborRows = bd.labor.map(l => `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="pl-4 py-2 text-gray-300 border-r border-white/5">${l.role}</td>
                    <td class="text-center py-2 border-r border-white/5 text-gray-400 text-xs">OH</td>
                    <td class="text-center py-2 border-r border-white/5 text-gray-400 font-mono text-xs">${l.coef.toFixed(4)}</td>
                    <td class="text-right py-2 border-r border-white/5 px-3 text-gray-400 font-mono text-xs">${ui.fmt(l.price)}</td>
                    <td class="text-right py-2 px-3 font-medium text-gray-300 font-mono text-xs">${ui.fmt(l.total)}</td>
                </tr>`).join('');

            ahspContainer.innerHTML += `
            <div class="bg-slate-900/80 rounded-xl overflow-hidden border border-white/10 shadow-lg mb-8 break-inside-avoid">
                <div class="bg-black/30 px-5 py-3 border-b border-white/10 flex justify-between items-center">
                    <h4 class="font-bold text-gray-100 text-sm flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px] font-bold">${idx+1}</span> 
                        ${item.title}
                    </h4>
                    <span class="text-[10px] font-bold uppercase text-gray-400 bg-white/5 px-2 py-1 rounded border border-white/5">Analisis per 1 ${item.unit}</span>
                </div>
                <table class="w-full text-xs text-gray-300">
                    <thead class="bg-black/20 text-gray-500 font-bold uppercase tracking-wider border-b border-white/5">
                        <tr><th class="text-left py-2 px-4 w-1/3">Uraian</th><th class="text-center py-2 w-10">Sat</th><th class="text-center py-2 w-16">Koefisien</th><th class="text-right py-2 px-3">Harga Satuan Dasar</th><th class="text-right py-2 px-3">Jumlah Harga</th></tr>
                    </thead>
                    <tbody>
                        <tr class="bg-blue-900/10"><td colspan="5" class="py-1 px-4 font-bold text-blue-400 border-b border-white/5 tracking-wide">A. TENAGA KERJA</td></tr>
                        ${laborRows}
                        <tr class="bg-amber-900/10"><td colspan="5" class="py-1 px-4 font-bold text-amber-400 border-b border-white/5 tracking-wide">B. BAHAN</td></tr>
                        ${auxRows}
                        <tr class="bg-purple-900/10"><td colspan="5" class="py-1 px-4 font-bold text-purple-400 border-b border-white/5 tracking-wide">C. PERALATAN</td></tr>
                        <tr class="border-b border-white/5"><td class="pl-4 py-2 text-gray-300 border-r border-white/5">Sewa Alat Bantu (5% Upah)</td><td class="text-center py-2 border-r border-white/5 text-gray-400 text-xs">Ls</td><td class="border-r border-white/5" colspan="2"></td><td class="text-right py-2 px-3 font-medium text-gray-300 font-mono text-xs">${ui.fmt(bd.tool)}</td></tr>
                    </tbody>
                    <tfoot class="bg-black/30 text-gray-100 font-bold border-t border-white/10">
                        <tr><td colspan="4" class="py-2 px-4 text-right text-[10px] uppercase tracking-widest text-gray-500">Total Harga Satuan</td><td class="py-2 px-3 text-right text-sm font-mono text-blue-400">${ui.fmt(item.unitPrice)}</td></tr>
                    </tfoot>
                </table>
            </div>`;
        });

        const profitVal = subtotal * profitPct;
        const taxVal = (subtotal + profitVal) * taxPct;
        const total = subtotal + profitVal + taxVal;

        document.getElementById('footer-fisik').innerText = ui.fmt(subtotal);
        document.getElementById('footer-profit').innerText = ui.fmt(profitVal);
        document.getElementById('footer-tax').innerText = ui.fmt(taxVal);
        document.getElementById('footer-total').innerText = ui.fmt(total);
        document.getElementById('disp-profit').innerText = (profitPct * 100);
        document.getElementById('disp-tax').innerText = (taxPct * 100);
        document.getElementById('val-physical').innerText = ui.fmt(subtotal);
        document.getElementById('val-total').innerText = ui.fmt(total);
        document.getElementById('val-perm2').innerText = ui.fmt(total / app.currentGeom.area) + " /m²";
    }
};

app.updateSource = (k,v) => { prices[k].source=v; localStorage.setItem('gazebo_prices', JSON.stringify(prices)); };

window.onload = app.init;
</script>
</body>
</html>

